# Copyright Google LLC All Rights Reserved.
#
# Use of this source code is governed by an MIT-style license that can be
# found in the LICENSE file at https://angular.io/license
"""Utilities to run yarn install as a build target"""

load("@build_bazel_rules_nodejs//:index.bzl", "npm_package_bin")
load("//:yarn.bzl", "YARN_LABEL", "YARN_PATH")

def node_modules(name = "node_modules", package_json = "package.json", yarn_lock = "yarn.lock", local_package_substitutions = []):
    """Install node modules as a tree artifact.

    Args:
        name: Optional name of the node_modules folder (default is node_modules)
        package_json: Optional label to package.json if not in the same package
        yarn_lock: Optional label to yarn.lock if not in the same package
        local_package_substitutions: Optional list of locally built packages to substitute
          for their npm equivalent
    """
    npm_package_bin(
        name = name,
        args = [
            "$(RULEDIR)",
            "$(execpath %s)" % package_json,
            "$(execpath %s)" % yarn_lock,
            "--modules-folder",
            name,
            "--local-packages",
        ] + [
            "$(execpath %s)" % pkg
            for pkg in local_package_substitutions
        ],
        data = [
            YARN_LABEL,
            package_json,
            yarn_lock,
        ] + local_package_substitutions,
        env = {
            "YARN": YARN_PATH,
        },
        outs = [name + ".tar"],
        tool = "//aio/tools/ng-packages-installer",
    )
